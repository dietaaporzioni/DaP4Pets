<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Dieta a Porzioni 4Pets</title>

  <style>
    :root{
      --bg:#F6F6F4;
      --card:#FFFFFF;
      --text:#111;
      --muted:#6B6B6B;
      --line:#E7E4DD;
      --shadow: 0 12px 24px rgba(0,0,0,.06);
      --radius: 18px;
      --pad: 18px;
      --btnRadius: 14px;

      --btnPrimaryBg:#111;
      --btnPrimaryTxt:#fff;
      --btnSecondaryBg:#fff;
      --btnSecondaryTxt:#111;

      --focus: rgba(0,0,0,.10);
      --errorBg:#fff1f1;
      --errorBd:#ffb4b4;
      --chipBg: rgba(0,0,0,.06);
      --chipBd: rgba(0,0,0,.12);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-text-size-adjust: 100%;
    }

    .topbar{
      height: 88px;
      background: linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,0));
      pointer-events:none;
    }

    .page{
      min-height: calc(100vh - 88px);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding: 14px;
    }

    .wrap{
      width: min(560px, 100%);
      padding-bottom: 22px;
      position: relative;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
      position: relative;
      z-index: 1;
    }

    /* BRAND (singolo) */
    .brandBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .brandName{
      font-weight: 1000;
      letter-spacing: -0.02em;
      font-size: 16px;
    }
    .brandTag{
      font-size: 12px;
      color: var(--muted);
      background: rgba(0,0,0,.04);
      border: 1px solid #EEEAE2;
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .title{
      font-size: 44px;
      font-weight: 900;
      letter-spacing: -0.02em;
      text-align:center;
      margin: 8px 0 6px;
    }

    .subtitle{
      text-align:center;
      color: var(--muted);
      font-size: 15px;
      line-height: 1.35;
      margin: 0 0 10px;
    }

    .stepPillWrap{ text-align:center; margin-bottom: 6px; }
    .stepPill{
      display:inline-block;
      border: 2px solid #222;
      border-radius: 10px;
      padding: 8px 14px;
      font-weight: 800;
      font-size: 14px;
      margin: 10px auto 0;
      background:#fff;
    }

    .sectionTitle{
      font-size: 26px;
      font-weight: 900;
      margin: 18px 0 10px;
    }

    .row{ display:flex; gap: 12px; flex-wrap: wrap; }
    .field{ flex: 1; min-width: 180px; margin-top: 10px; }

    .labelRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      margin-bottom:6px;
    }

    label{
      display:block;
      font-size: 12px;
      color: #7A7A7A;
      letter-spacing: .01em;
    }

    input, select{
      width:100%;
      padding: 14px 14px;
      border-radius: 12px;
      border: 1px solid #E3E0DA;
      outline:none;
      font-size: 16px;
      background:#fff;
    }

    input:focus, select:focus{
      border-color: #111;
      box-shadow: 0 0 0 4px var(--focus);
    }

    .errorField{
      border-color: var(--errorBd) !important;
      background: var(--errorBg) !important;
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.35;
    }

    .errorMsg{
      display:none;
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      background: var(--errorBg);
      border: 1px solid var(--errorBd);
      color:#7a0b0b;
      font-size: 13px;
      line-height: 1.35;
    }

    .divider{ height: 1px; background: var(--line); margin: 18px 0; }

    .kv{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap: 14px;
      padding: 10px 0;
    }
    .k{ color: #666; font-size: 15px;}
    .vSmall{ font-size: 20px; font-weight: 900; text-align:right; }

    .chipValue{
      display:inline-block;
      background: var(--chipBg);
      border: 2px solid var(--chipBd);
      color:#111;
      font-weight: 900;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 18px;
      white-space: nowrap;
    }

    .chipCalc{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 14px 14px;
      border-radius: 12px;
      border: 1px dashed rgba(0,0,0,.25);
      background: rgba(0,0,0,.03);
      color:#111;
      font-weight: 900;
    }
    .chipCalc small{
      display:block;
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
      margin-top: 2px;
    }
    .lock{
      width: 26px; height: 26px;
      border-radius: 10px;
      border: 2px solid #111;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 14px;
      background:#fff;
      flex: 0 0 auto;
    }

    .footerBtns{
      display:flex;
      gap: 12px;
      margin-top: 18px;
    }

    button, .btn, .toggle, .iBtn{
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      user-select: none;
    }

    .btn{
      flex:1;
      padding: 16px 14px;
      border-radius: var(--btnRadius);
      font-weight: 900;
      font-size: 18px;
      cursor:pointer;
      border: 2px solid #111;
      background: var(--btnSecondaryBg);
      color: var(--btnSecondaryTxt);
    }
    .btnPrimary{
      background: var(--btnPrimaryBg);
      color: var(--btnPrimaryTxt);
      border-color: transparent;
    }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }

    .mutedBox{
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.03);
      border: 1px solid #ECEAE4;
      font-size: 13px;
      color:#5f5f5f;
      line-height: 1.35;
      margin-top: 12px;
      white-space: pre-line;
    }

    .smallToggleRow{
      display:flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .toggle{
      flex:1;
      min-width: 220px;
      border: 1px solid #E3E0DA;
      border-radius: 14px;
      padding: 12px;
      cursor:pointer;
      background:#fff;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
    }
    .toggle.active{
      border-color: #111;
      box-shadow: 0 0 0 4px var(--focus);
    }
    .toggle b{ font-size: 14px; }
    .toggle span{ font-size: 12px; color: var(--muted); display:block; margin-top:4px; }
    .toggle .dot{
      width: 14px; height: 14px; border-radius: 50%;
      border: 2px solid #111;
      background:#fff;
    }
    .toggle.active .dot{ background:#111; }

    .iBtn{
      width: 22px; height: 22px;
      border-radius: 50%;
      border: 2px solid #111;
      background:#fff;
      color:#111;
      font-weight: 1000;
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      flex: 0 0 auto;
    }

    .dayList{ margin-top: 12px; display:flex; flex-direction:column; gap: 10px; }
    .dayRow{
      border: 1px solid #ECEAE4;
      border-radius: 14px;
      padding: 12px;
      background:#fff;
    }
    .dayRowTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .dayRowTop b{ font-size: 14px; }
    .miniBtn{
      border: 2px solid #111;
      background:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
    }
    .inlineBtns{ display:flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }

    /* Modal */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 9999;
    }
    .modal{
      width: min(520px, 100%);
      background:#fff;
      border-radius: 18px;
      border: 1px solid #E7E4DD;
      box-shadow: 0 16px 36px rgba(0,0,0,.18);
      padding: 16px;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .modalHeader b{ font-size: 16px; }
    .xBtn{
      width: 38px; height: 38px;
      border-radius: 14px;
      border: 2px solid #111;
      background:#fff;
      font-weight: 1000;
      cursor:pointer;
    }
    .modalBody{ color:#333; font-size: 14px; line-height: 1.45; }
    .modalBody img{ width:100%; border-radius: 14px; border: 1px solid #ECEAE4; background:#fafafa; }

    /* BCS palette alignment (warm/earthy filter) */
    .bcsImg{
      width:100%;
      border-radius: 14px;
      border: 1px solid #ECEAE4;
      background:#fff;
      filter: saturate(0.95) sepia(0.22) contrast(1.03) brightness(1.02);
    }
    .bcsCaption{
      margin-top:10px;
      font-size: 12px;
      color: #666;
    }

    /* Capture area */
    .capture{
      border-radius: 18px;
      border: 1px solid #E7E4DD;
      padding: 14px;
      background:#fff;
    }

    /* Tiny toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 22px;
      transform: translateX(-50%);
      background: #111;
      color: #fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 800;
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease;
      z-index: 99999;
      max-width: 92vw;
      text-align:center;
    }
    .toast.show{ opacity: 0.95; }

    @media (max-width:420px){
      .title{ font-size: 38px; }
      .btn{ font-size: 17px; }
    }
  </style>
</head>

<body>
  <div class="topbar"></div>

  <div class="page">
    <div class="wrap">

      <div class="card">

        <div class="brandBar">
          <div class="brandName">Dieta a Porzioni 4Pets</div>
          <div class="brandTag">stima fabbisogno</div>
        </div>

        <!-- STEP 1 -->
        <section id="step1">
          <div class="title">Informazioni</div>
          <div class="subtitle">Inserisci i dati principali del tuo cane</div>
          <div class="stepPillWrap"><span class="stepPill">Passo 1/3</span></div>

          <div class="sectionTitle">Dati del cane</div>

          <div class="row">
            <div class="field" style="min-width: 240px;">
              <div class="labelRow"><label>Nome cane (opzionale)</label></div>
              <input id="dogName" placeholder="Es. Luna" />
            </div>

            <div class="field">
              <div class="labelRow">
                <label>Peso attuale (kg)</label>
                <button class="iBtn" type="button" data-info="peso">i</button>
              </div>
              <input id="peso" type="text" inputmode="decimal" placeholder="Es. 18,5" />
              <div class="hint">Inserisci il peso attuale, non quello previsto da adulto.</div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <div class="labelRow">
                <label>Et√†</label>
                <button class="iBtn" type="button" data-info="eta">i</button>
              </div>
              <div class="row" style="gap:10px;">
                <div class="field" style="min-width: 160px; margin-top:0;">
                  <input id="etaVal" type="text" inputmode="decimal" placeholder="Es. 8" />
                </div>
                <div class="field" style="min-width: 140px; margin-top:0;">
                  <select id="etaUnit">
                    <option value="anni" selected>anni</option>
                    <option value="mesi">mesi</option>
                  </select>
                </div>
              </div>
              <div class="hint">Puoi inserire anni o mesi.</div>
            </div>

            <div class="field">
              <div class="labelRow">
                <label>Fase di vita (auto)</label>
                <button class="iBtn" type="button" data-info="fase">i</button>
              </div>
              <div class="chipCalc" aria-readonly="true">
                <div>
                  <div id="faseLabel">‚Äî</div>
                  <small>calcolata automaticamente</small>
                </div>
                <div class="lock">üîí</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <div class="labelRow">
                <label>BCS (1‚Äì9) ‚Äì opzionale</label>
                <button class="iBtn" type="button" data-info="bcs">i</button>
              </div>
              <input id="bcs" type="number" step="1" min="1" max="9" placeholder="Es. 5" />
            </div>

            <div class="field">
              <div class="labelRow">
                <label>Obiettivo</label>
                <button class="iBtn" type="button" data-info="target">i</button>
              </div>
              <select id="obiettivo">
                <option value="mantenimento" selected>Mantenimento</option>
                <option value="dimagrimento">Dimagrimento</option>
                <option value="aumento">Aumento peso</option>
              </select>
            </div>
          </div>

          <div class="errorMsg" id="err1"></div>

          <div class="footerBtns">
            <button class="btn" type="button" disabled>Indietro</button>
            <button class="btn btnPrimary" type="button" id="toStep2">Avanti</button>
          </div>
        </section>

        <!-- STEP 2 -->
        <section id="step2" style="display:none;">
          <div class="title">Recap</div>
          <div class="subtitle">Inserisci l‚Äôattivit√† del cane</div>
          <div class="stepPillWrap"><span class="stepPill">Passo 2/3</span></div>

          <div class="smallToggleRow">
            <div class="toggle active" id="tgDay">
              <div><b>Modalit√† Giornaliera</b><span>Inserisci i giorni a mano</span></div>
              <div class="dot"></div>
            </div>
            <div class="toggle" id="tgAvg">
              <div><b>Modalit√† Media</b><span>Stima rapida sett./mese</span></div>
              <div class="dot"></div>
            </div>
          </div>

          <div id="panelDay" style="margin-top:12px;">
            <div class="sectionTitle" style="margin-top:16px;">Attivit√† giornaliera</div>
            <div class="mutedBox">Inserisci per ogni giorno i <b>km percorsi</b> e l‚Äôintensit√†.</div>

            <div class="inlineBtns">
              <button class="miniBtn" type="button" id="btnAddDay">+ Aggiungi giorno</button>
              <button class="miniBtn" type="button" id="btnAddWeek">+ Settimana (7 giorni)</button>
              <button class="miniBtn" type="button" id="btnResetDays">Svuota</button>
            </div>

            <div class="dayList" id="dayList"></div>
          </div>

          <div id="panelAvg" style="display:none; margin-top:12px;">
            <div class="sectionTitle" style="margin-top:16px;">Media</div>

            <div class="row">
              <div class="field">
                <div class="labelRow"><label>Periodo</label></div>
                <select id="periodo">
                  <option value="7" selected>Settimana (7 giorni)</option>
                  <option value="30">Mese (30 giorni)</option>
                </select>
              </div>

              <div class="field">
                <div class="labelRow"><label>Media km/giorno</label></div>
                <input id="mediaKm" type="text" inputmode="decimal" placeholder="Es. 3,5" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <div class="labelRow">
                  <label>Media minuti attivi/giorno ‚Äì opzionale</label>
                  <button class="iBtn" type="button" data-info="minuti">i</button>
                </div>
                <input id="mediaMinuti" type="number" step="1" min="0" placeholder="Es. 60" />
              </div>

              <div class="field">
                <div class="labelRow">
                  <label>Intensit√† media</label>
                  <button class="iBtn" type="button" data-info="intensita">i</button>
                </div>
                <select id="intMedia">
                  <option value="2" selected>Normale</option>
                  <option value="1">Lento</option>
                  <option value="3">Spedito</option>
                  <option value="4">Corsa</option>
                </select>
              </div>
            </div>
          </div>

          <div class="errorMsg" id="err2"></div>

          <div class="footerBtns">
            <button class="btn" type="button" id="backTo1">Indietro</button>
            <button class="btn btnPrimary" type="button" id="toStep3">Avanti</button>
          </div>
        </section>

        <!-- STEP 3 -->
        <section id="step3" style="display:none;">
          <div class="title">Recap</div>
          <div class="subtitle">Riepilogo (le kcal saranno visibili nella schermata finale)</div>
          <div class="stepPillWrap"><span class="stepPill">Passo 3/3</span></div>

          <div class="sectionTitle">Informazioni cane</div>
          <div class="kv"><div class="k">Nome</div><div class="vSmall" id="sumName">‚Äî</div></div>
          <div class="kv"><div class="k">Peso attuale</div><div class="vSmall" id="sumPeso">‚Äî</div></div>
          <div class="kv"><div class="k">Et√†</div><div class="vSmall" id="sumEta">‚Äî</div></div>
          <div class="kv"><div class="k">Fase di vita</div><div class="vSmall" id="sumFase">‚Äî</div></div>
          <div class="kv"><div class="k">Obiettivo</div><div class="vSmall" id="sumObj">‚Äî</div></div>
          <div class="kv"><div class="k">Attivit√†</div><div class="vSmall" id="sumMode">‚Äî</div></div>

          <div class="divider"></div>

          <div class="sectionTitle">Target giornaliero</div>
          <div class="mutedBox">
            Il target in kcal verr√† mostrato nella schermata finale, pronto da condividere.
          </div>

          <div class="footerBtns">
            <button class="btn" type="button" id="backTo2">Indietro</button>
            <button class="btn btnPrimary" type="button" id="btnGenerate">Vedi kcal</button>
          </div>
        </section>

        <!-- RESULT (alleggerita) -->
        <section id="result" style="display:none;">
          <div id="captureArea" class="capture">
            <!-- UN SOLO HEADER -->
            <div class="brandBar" style="margin-bottom:6px;">
              <div class="brandName">Dieta a Porzioni 4Pets</div>
              <div class="brandTag" id="resBadge">kcal giornaliere</div>
            </div>

            <div class="title" id="resTitle">kcal di ‚Äî</div>
            <div class="subtitle" id="resSubtitle">stima giornaliera</div>

            <div class="sectionTitle">Risultato</div>
            <div class="kv">
              <div class="k">Target giornaliero</div>
              <div class="chipValue" id="resTarget">‚Äî kcal</div>
            </div>

            <div class="divider"></div>

            <div class="kv"><div class="k">kcal base</div><div class="vSmall" id="resBase">‚Äî</div></div>
            <div class="kv"><div class="k">kcal attivit√†</div><div class="vSmall" id="resAct">‚Äî</div></div>
            <div class="kv"><div class="k">DER totale</div><div class="vSmall" id="resDer">‚Äî</div></div>

            <div class="mutedBox" id="resNote">‚Äî</div>
          </div>

          <!-- solo 2 bottoni -->
          <div class="footerBtns">
            <button class="btn" type="button" id="btnRestart">Ricomincia</button>
            <button class="btn btnPrimary" type="button" id="btnShare">Condividi</button>
          </div>

          <div class="mutedBox" style="margin-top:12px;">
            Tip: condividi su WhatsApp/Instagram e tagga <b>#DietaAPorzioni4Pets</b> üêæ
          </div>
        </section>

      </div>
    </div>
  </div>

  <!-- MODAL INFO -->
  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <b id="modalTitle">Info</b>
        <button class="xBtn" type="button" id="modalClose">√ó</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast">Testo copiato ‚úÖ Ora condividi üòâ</div>

  <!-- html2canvas (affidabile per immagine) -->
  <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  /* ========= MOBILE TAP FIX ========= */
  function bindTap(el, fn){
    if(!el) return;
    el.addEventListener("pointerup", (e)=>{ fn(e); }, {passive:true});
    el.addEventListener("touchend", (e)=>{ e.preventDefault(); fn(e); }, {passive:false});
    el.addEventListener("click", (e)=>{ fn(e); }, {passive:true});
  }

  const $ = (id)=>document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1800);
  }

  /* ========= MODELLI ========= */
  const M_BASE_FISSO = 1.20;
  const K_INT = { 1:0.60, 2:0.80, 3:1.00, 4:1.30 };

  function nvalFrom(el){
    const raw = String(el?.value ?? "").trim().replace(",",".");
    const v = parseFloat(raw);
    return (isFinite(v) ? v : null);
  }

  function rer(pesoKg){
    if(!pesoKg || pesoKg<=0) return 0;
    return 70 * Math.pow(pesoKg, 0.75);
  }
  function kcalBase(pesoKg){ return rer(pesoKg) * M_BASE_FISSO; }

  function fattoreTarget(obiettivo, bcs){
    if(obiettivo === "dimagrimento") return (bcs!=null && bcs>=7) ? 0.80 : 0.85;
    if(obiettivo === "aumento") return 1.10;
    return 1.00;
  }

  function ageYears(){
    const v = nvalFrom($("etaVal"));
    if(v==null || v<0) return null;
    return ($("etaUnit").value==="mesi") ? (v/12.0) : v;
  }

  function lifeStageFromAgeYears(ageY){
    if(ageY==null) return {label:"‚Äî", mult:1.00};
    if(ageY < 1) return {label:"Cucciolo", mult:1.20};
    if(ageY < 8) return {label:"Adulto", mult:1.00};
    return {label:"Senior", mult:0.95};
  }

  /* ========= UI STATE ========= */
  let mode = "day";
  let days = []; // {id,date,km,int,minuti}

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  function setMode(m){
    mode = m;
    $("tgDay").classList.toggle("active", m==="day");
    $("tgAvg").classList.toggle("active", m==="avg");
    $("panelDay").style.display = (m==="day") ? "" : "none";
    $("panelAvg").style.display = (m==="avg") ? "" : "none";
    hideErr("err2");
  }

  function showStep(n){
    ["step1","step2","step3","result"].forEach(id=>$(id).style.display="none");
    $(n).style.display = "";
    window.scrollTo({top:0, behavior:"smooth"});
  }

  function showErr(id, msg){
    const box = $(id);
    box.textContent = msg;
    box.style.display = "block";
  }
  function hideErr(id){
    const box = $(id);
    box.textContent = "";
    box.style.display = "none";
  }

  function updateLifeStage(){
    const st = lifeStageFromAgeYears(ageYears());
    $("faseLabel").textContent = st.label;
  }

  /* ========= Giornaliera UI ========= */
  function addDayRow(dateStr=null){
    const d = new Date();
    const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
    days.unshift({
      id: uid(),
      date: dateStr || `${yyyy}-${mm}-${dd}`,
      km: "",
      int: "2",
      minuti: ""
    });
    renderDayList();
  }

  function addWeek(){
    const today = new Date();
    for(let i=0;i<7;i++){
      const d = new Date(today);
      d.setDate(today.getDate()-i);
      const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
      addDayRow(`${yyyy}-${mm}-${dd}`);
    }
  }

  function resetDays(){ days=[]; renderDayList(); }
  function removeDay(id){ days = days.filter(x=>x.id!==id); renderDayList(); }

  function renderDayList(){
    const wrap = $("dayList");
    wrap.innerHTML = "";

    if(days.length===0){
      const box = document.createElement("div");
      box.className = "mutedBox";
      box.textContent = "Nessun giorno inserito. Tocca ‚Äú+ Aggiungi giorno‚Äù oppure ‚Äú+ Settimana (7 giorni)‚Äù.";
      wrap.appendChild(box);
      return;
    }

    for(const d of days){
      const card = document.createElement("div");
      card.className = "dayRow";
      card.innerHTML = `
        <div class="dayRowTop">
          <b>Giorno</b>
          <button class="miniBtn" type="button" data-del="${d.id}">Rimuovi</button>
        </div>

        <div class="row">
          <div class="field" style="min-width: 220px;">
            <div class="labelRow"><label>Data</label></div>
            <input type="date" value="${d.date}" data-k="date" data-id="${d.id}" />
          </div>

          <div class="field">
            <div class="labelRow"><label>Km percorsi</label></div>
            <input type="text" inputmode="decimal" placeholder="Es. 3,2" value="${d.km}" data-k="km" data-id="${d.id}" />
            <div class="hint">Somma camminate + uscite + gioco.</div>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <div class="labelRow"><label>Intensit√†</label></div>
            <select data-k="int" data-id="${d.id}">
              <option value="1" ${d.int==="1"?"selected":""}>Lento</option>
              <option value="2" ${d.int==="2"?"selected":""}>Normale</option>
              <option value="3" ${d.int==="3"?"selected":""}>Spedito</option>
              <option value="4" ${d.int==="4"?"selected":""}>Corsa</option>
            </select>
          </div>

          <div class="field">
            <div class="labelRow"><label>Minuti attivi ‚Äì opzionale</label></div>
            <input type="number" min="0" step="1" placeholder="Es. 60" value="${d.minuti}" data-k="minuti" data-id="${d.id}" />
          </div>
        </div>
      `;
      wrap.appendChild(card);
    }

    wrap.querySelectorAll("[data-del]").forEach(btn=>{
      bindTap(btn, ()=>{
        const id = btn.getAttribute("data-del");
        removeDay(id);
      });
    });

    wrap.querySelectorAll("[data-id][data-k]").forEach(el=>{
      el.addEventListener("input", ()=>{
        const id = el.getAttribute("data-id");
        const k = el.getAttribute("data-k");
        days = days.map(x => x.id===id ? {...x, [k]: el.value} : x);
      });
      el.addEventListener("change", ()=>{
        const id = el.getAttribute("data-id");
        const k = el.getAttribute("data-k");
        days = days.map(x => x.id===id ? {...x, [k]: el.value} : x);
      });
    });
  }

  /* ========= Calcolo ========= */
  function compute(){
    const dogName = ($("dogName").value||"").trim() || "‚Äî";
    const peso = nvalFrom($("peso"));
    const ageY = ageYears();
    const stage = lifeStageFromAgeYears(ageY);

    const ob = $("obiettivo").value;
    const bcs = ($("bcs").value.trim()==="") ? null : parseInt($("bcs").value,10);
    const fTarget = fattoreTarget(ob, bcs);

    const base = kcalBase(peso);

    let kcalAtt = 0;
    let der = 0;

    if(mode==="day"){
      const validDays = days
        .map(d=>{
          const km = nvalFrom({value:d.km});
          const K = K_INT[parseInt(d.int,10)] ?? 0.80;
          if(km==null || km<0) return null;
          const act = km * peso * K;
          return {act, der: base + act};
        })
        .filter(Boolean);

      kcalAtt = validDays.reduce((s,x)=>s+x.act,0) / validDays.length;
      der = validDays.reduce((s,x)=>s+x.der,0) / validDays.length;
    } else {
      const km = nvalFrom($("mediaKm"));
      const K = K_INT[parseInt($("intMedia").value,10)] ?? 0.80;
      kcalAtt = km * peso * K;
      der = base + kcalAtt;
    }

    const derLife = der * stage.mult;
    const target = derLife * fTarget;

    return {dogName, peso, ageY, stageLabel: stage.label, stageMult: stage.mult, ob, base, kcalAtt, derLife, target, fTarget};
  }

  function cap(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : "‚Äî"; }

  function fmtAge(){
    const unit = $("etaUnit").value;
    const v = nvalFrom($("etaVal"));
    if(v==null) return "‚Äî";
    return (unit==="mesi") ? `${v.toFixed(0)} mesi` : `${v.toFixed(1)} anni`;
  }

  function updateSummary(){
    const c = compute();
    $("sumName").textContent = c.dogName;
    $("sumPeso").textContent = `${c.peso.toFixed(1)} kg`;
    $("sumEta").textContent = fmtAge();
    $("sumFase").textContent = c.stageLabel;
    $("sumObj").textContent = cap(c.ob);
    $("sumMode").textContent = (mode==="day") ? "Giornaliera" : "Media";
  }

  /* ========= Share (1 bottone) ========= */
  function buildShareText(c){
    const dog = (c.dogName==="‚Äî") ? "il mio cane" : c.dogName;
    const kcal = Math.round(c.target);
    return `Ho calcolato le kcal giornaliere di ${dog}: ${kcal} kcal üêæ

Calcolate con Dieta a Porzioni 4Pets.
#DietaAPorzioni4Pets #4Pets #dognutrition`;
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      window.prompt("Copia il testo qui sotto:", text);
      return false;
    }
  }

  async function renderCapturePng(){
    const el = $("captureArea");
    const canvas = await html2canvas(el, {
      backgroundColor: "#ffffff",
      scale: Math.min(2, window.devicePixelRatio || 1),
      useCORS: true
    });
    return new Promise((resolve)=>canvas.toBlob(resolve, "image/png", 0.95));
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function shareFlow(){
    const c = compute();
    const dog = (c.dogName==="‚Äî") ? "cane" : c.dogName;
    const filename = `kcal-di-${dog}.png`.replace(/\s+/g,"-").toLowerCase();
    const text = buildShareText(c);

    // incentivo: testo copiato sempre
    await copyToClipboard(text);
    toast("Testo copiato ‚úÖ Ora condividi üòâ");

    // immagine
    let blob;
    try{
      blob = await renderCapturePng();
    }catch(e){
      alert("Non riesco a creare l‚Äôimmagine qui. Apri la pagina da un link https (es. GitHub Pages) e riprova.");
      return;
    }

    // share sheet se possibile
    try{
      const file = new File([blob], filename, {type:"image/png"});
      if(navigator.canShare && navigator.canShare({files:[file]}) && navigator.share){
        await navigator.share({
          title: "Dieta a Porzioni 4Pets",
          text,
          files: [file]
        });
        return;
      }
    }catch(e){
      // fallback
    }

    // fallback download
    downloadBlob(blob, filename);
    toast("Immagine salvata ‚úÖ Incolla il testo e pubblica!");
  }

  /* ========= Modal Info ========= */
  const BCS_IMAGE_URL = "images-8.jpeg"; // mettila nella stessa cartella del file quando pubblichi

  function openModal(title, bodyHtml){
    $("modalTitle").textContent = title;
    $("modalBody").innerHTML = bodyHtml;
    $("modalOverlay").style.display = "flex";
    $("modalOverlay").setAttribute("aria-hidden","false");
  }
  function closeModal(){
    $("modalOverlay").style.display = "none";
    $("modalOverlay").setAttribute("aria-hidden","true");
  }

  function openInfo(key){
    if(key==="peso"){
      openModal("Peso attuale",
        `<div>Inserisci il <b>peso attuale</b> del cane (non quello previsto da adulto). √à il dato che guida i calcoli.</div>`
      );
      return;
    }
    if(key==="eta"){
      openModal("Et√† (anni o mesi)",
        `<div>Puoi inserire l‚Äôet√† in <b>anni</b> oppure in <b>mesi</b>. Serve per stimare la <b>fase di vita</b> automaticamente.</div>`
      );
      return;
    }
    if(key==="fase"){
      openModal("Fase di vita (automatica)",
        `<div>
          Regola semplice:
          <div style="margin-top:8px;">
            ‚Ä¢ <b>Cucciolo</b> (&lt; 1 anno): +20%<br>
            ‚Ä¢ <b>Adulto</b> (1‚Äì7): 0%<br>
            ‚Ä¢ <b>Senior</b> (‚â• 8): -5%
          </div>
          <div style="margin-top:8px;color:#666;">
            √à una correzione media: alcuni cani possono avere bisogni diversi.
          </div>
        </div>`
      );
      return;
    }
    if(key==="bcs"){
      openModal("BCS (Body Condition Score)",
        `<div style="margin-bottom:10px;">
          Scala 1‚Äì9 per valutare la condizione corporea. In dimagrimento rende il target pi√π prudente.
        </div>
        <img class="bcsImg" src="${BCS_IMAGE_URL}" alt="BCS" />
        <div class="bcsCaption">Nota: immagine resa pi√π ‚Äúcalda‚Äù per allineamento visivo al brand.</div>`
      );
      return;
    }
    if(key==="target"){
      openModal("Obiettivo",
        `<div>
          ‚Ä¢ <b>Mantenimento</b>: 100% del dispendio stimato<br>
          ‚Ä¢ <b>Dimagrimento</b>: 85% (80% se BCS ‚â• 7)<br>
          ‚Ä¢ <b>Aumento peso</b>: 110%
        </div>`
      );
      return;
    }
    if(key==="minuti"){
      openModal("Minuti attivi (opzionale)",
        `<div>Dato facoltativo. Il calcolo principale usa <b>km</b> e <b>intensit√†</b>.</div>`
      );
      return;
    }
    if(key==="intensita"){
      openModal("Intensit√†",
        `<div>
          Fattore di sforzo (K):
          <div style="margin-top:8px;">
            ‚Ä¢ Lento: 0,60<br>
            ‚Ä¢ Normale: 0,80<br>
            ‚Ä¢ Spedito: 1,00<br>
            ‚Ä¢ Corsa: 1,30
          </div>
        </div>`
      );
      return;
    }
  }

  /* ========= Bind events ========= */
  bindTap($("tgDay"), ()=>setMode("day"));
  bindTap($("tgAvg"), ()=>setMode("avg"));

  document.querySelectorAll(".iBtn[data-info]").forEach(btn=>{
    bindTap(btn, ()=>openInfo(btn.getAttribute("data-info")));
  });

  bindTap($("modalClose"), closeModal);
  bindTap($("modalOverlay"), (e)=>{ if(e.target === $("modalOverlay")) closeModal(); });

  $("etaVal").addEventListener("input", updateLifeStage);
  $("etaVal").addEventListener("change", updateLifeStage);
  $("etaUnit").addEventListener("change", updateLifeStage);

  bindTap($("toStep2"), ()=>{
    hideErr("err1");
    $("peso").classList.remove("errorField");

    const peso = nvalFrom($("peso"));
    if(peso==null || peso<=0){
      $("peso").classList.add("errorField");
      showErr("err1", "Inserisci il peso attuale del cane (numero > 0). Esempio: 18,5");
      $("peso").focus();
      return;
    }

    updateLifeStage();
    showStep("step2");
  });

  bindTap($("backTo1"), ()=>showStep("step1"));
  bindTap($("backTo2"), ()=>showStep("step2"));

  bindTap($("btnAddDay"), ()=>addDayRow());
  bindTap($("btnAddWeek"), addWeek);
  bindTap($("btnResetDays"), resetDays);

  bindTap($("toStep3"), ()=>{
    hideErr("err2");

    const peso = nvalFrom($("peso"));
    if(peso==null || peso<=0){
      showErr("err2", "Peso non valido. Torna indietro e inserisci il peso attuale del cane.");
      return;
    }

    if(mode==="day"){
      if(days.length===0){
        showErr("err2", "In modalit√† Giornaliera aggiungi almeno un giorno.");
        return;
      }
      const anyValid = days.some(d=>{
        const km = nvalFrom({value:d.km});
        return km!=null && km>=0;
      });
      if(!anyValid){
        showErr("err2", "Inserisci almeno un valore di km (es. 3,2) in uno dei giorni.");
        return;
      }
    } else {
      const km = nvalFrom($("mediaKm"));
      if(km==null || km<0){
        showErr("err2", "In modalit√† Media inserisci la media km/giorno.");
        $("mediaKm").focus();
        return;
      }
    }

    updateSummary();
    showStep("step3");
  });

  bindTap($("btnGenerate"), ()=>{
    const c = compute();
    const dog = (c.dogName === "‚Äî") ? "cane" : c.dogName;

    $("resTitle").textContent = `kcal di ${dog}`;
    $("resSubtitle").textContent = `${c.stageLabel} ‚Ä¢ ${cap(c.ob)} ‚Ä¢ ${mode==="day" ? "giornaliera" : "media"}`;

    $("resBase").textContent = `${Math.round(c.base)} kcal`;
    $("resAct").textContent = `${Math.round(c.kcalAtt)} kcal`;
    $("resDer").textContent = `${Math.round(c.derLife)} kcal`;
    $("resTarget").textContent = `${Math.round(c.target)} kcal`;

    $("resNote").textContent =
      `Fase di vita: ${c.stageLabel} (√ó${c.stageMult.toFixed(2)}) ‚Ä¢ Obiettivo: √ó${c.fTarget.toFixed(2)}.`;

    showStep("result");
  });

  bindTap($("btnRestart"), ()=>showStep("step1"));
  bindTap($("btnShare"), shareFlow);

  /* ========= init ========= */
  setMode("day");
  showStep("step1");
  updateLifeStage();
  renderDayList();
</script>

</body>
</html>
